<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Library Admin Panel</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Icons -->
  <script src="https://unpkg.com/phosphor-icons"></script>

  <style>
    /* Smooth fade animations */
    .fade {
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Toast notification */
    #toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
      display: none;
    }

    .glass {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(10px);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen flex">

  <!-- ============================
       SIDEBAR
  ============================ -->
  <aside class="w-64 bg-white shadow-xl border-r border-indigo-100 h-screen p-6 fixed left-0 top-0">

    <h1 class="text-3xl font-extrabold text-indigo-600 mb-8 flex gap-2 items-center">
      <i class="ph-book-duotone text-indigo-700 text-4xl"></i>
      Admin
    </h1>

    <nav class="flex flex-col gap-3 text-lg font-medium">

      <button class="tab-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-indigo-100 transition"
        data-tab="dashboard">
        <i class="ph-chart-pie-slice-fill text-indigo-600"></i> Dashboard
      </button>

      <button class="tab-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-indigo-100 transition"
        data-tab="books">
        <i class="ph-books-fill text-indigo-600"></i> Books
      </button>

      <button class="tab-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-indigo-100 transition"
        data-tab="issues">
        <i class="ph-notebook-fill text-indigo-600"></i> Issued Books
      </button>

      <button class="tab-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-indigo-100 transition"
        data-tab="return-requests">
        <i class="ph-arrow-u-up-left-fill text-indigo-600"></i> Return Requests
      </button>

      <button class="tab-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-indigo-100 transition"
        data-tab="reservations">
        <i class="ph-calendar-check-fill text-indigo-600"></i> Reservations
      </button>

      <button class="tab-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-indigo-100 transition"
        data-tab="fines">
        <i class="ph-currency-inr-fill text-indigo-600"></i> Fines
      </button>

    </nav>
  </aside>

  <!-- ============================
       MAIN CONTENT
  ============================ -->
  <main class="ml-72 w-full p-8 fade">

    <!-- Toast Notification -->
    <div id="toast" class="glass shadow-xl px-4 py-2 rounded-lg text-white font-semibold bg-indigo-600"></div>

    <!-- BOOKS TAB -->
    <div id="tab-books" class="tab-content hidden fade">

      <h2 class="text-3xl font-bold mb-4 text-indigo-700">ðŸ“˜ Manage Books</h2>

      <!-- ADD BOOK FORM -->
      <div class="glass p-6 rounded-xl shadow-xl mb-8 border border-indigo-100">
        <h3 class="text-xl font-bold mb-3 text-indigo-700">âž• Add New Book</h3>

        <div class="grid grid-cols-2 gap-4">
          <input id="b_title" class="p-3 border rounded-xl shadow-sm" placeholder="Book Title">
          <input id="b_author" class="p-3 border rounded-xl shadow-sm" placeholder="Author">
          <input id="b_category" class="p-3 border rounded-xl shadow-sm" placeholder="Category (Python/ML/AI)">
          <input id="b_rack" class="p-3 border rounded-xl shadow-sm" placeholder="Rack Number">
          <input id="b_total" type="number" class="p-3 border rounded-xl shadow-sm" placeholder="Total Copies">
        </div>

        <button onclick="addBook()" 
          class="mt-5 px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl shadow">
          Add Book
        </button>
      </div>

      <div id="booksList" class="glass p-6 rounded-xl shadow-xl border border-indigo-100">
        Loading books...
      </div>
    </div>

    <!-- ISSUED TAB -->
    <div id="tab-issues" class="tab-content hidden fade">
      <h2 class="text-3xl font-bold mb-4 text-indigo-700">ðŸ“• Issued Books</h2>
      <div id="issuedList" class="glass p-6 rounded-xl shadow-xl border">Loading...</div>
    </div>

    <!-- RETURN REQUESTS TAB -->
    <div id="tab-return-requests" class="tab-content hidden fade">
      <h2 class="text-3xl font-bold mb-4 text-indigo-700">ðŸ”„ Return Requests</h2>
      <div id="returnReqList" class="glass p-6 rounded-xl shadow-xl border">Loading...</div>
    </div>

    <!-- RESERVATIONS TAB -->
    <div id="tab-reservations" class="tab-content hidden fade">
      <h2 class="text-3xl font-bold mb-4 text-indigo-700">ðŸ“Œ Reservations</h2>
      <div id="reserveList" class="glass p-6 rounded-xl shadow-xl border">Loading...</div>
    </div>

    <!-- FINES TAB -->
    <div id="tab-fines" class="tab-content hidden fade">
      <h2 class="text-3xl font-bold mb-4 text-indigo-700">ðŸ’° Pending Fines</h2>
      <div id="finesList" class="glass p-6 rounded-xl shadow-xl border">Loading...</div>
    </div>

    <!-- DASHBOARD TAB -->
    <div id="tab-dashboard" class="tab-content fade">

      <h2 class="text-3xl font-bold mb-6 text-indigo-700">ðŸ“Š Dashboard Analytics</h2>

      <!-- STAT CARDS -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">

        <div class="glass p-5 shadow-xl rounded-xl text-center">
          <h4 class="text-indigo-700 font-semibold">Total Books</h4>
          <p id="stat_total_books" class="text-4xl font-extrabold text-purple-700">0</p>
        </div>

        <div class="glass p-5 shadow-xl rounded-xl text-center">
          <h4 class="text-indigo-700 font-semibold">Issued</h4>
          <p id="stat_issued" class="text-4xl font-extrabold text-purple-700">0</p>
        </div>

        <div class="glass p-5 shadow-xl rounded-xl text-center">
          <h4 class="text-indigo-700 font-semibold">Reservations</h4>
          <p id="stat_reservations" class="text-4xl font-extrabold text-purple-700">0</p>
        </div>

      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <div class="glass p-6 rounded-xl shadow-xl border">
          <h3 class="font-bold mb-2 text-indigo-700">ðŸ“‚ Books by Category</h3>
          <canvas id="chartCategories"></canvas>
        </div>

        <div class="glass p-6 rounded-xl shadow-xl border">
          <h3 class="font-bold mb-2 text-indigo-700">ðŸ“ˆ Issued vs Reservations</h3>
          <canvas id="chartIssued"></canvas>
        </div>

        <div class="glass p-6 rounded-xl shadow-xl border col-span-2">
          <h3 class="font-bold mb-2 text-indigo-700">ðŸ”¥ Top 5 Issued Books</h3>
          <canvas id="chartTopBooks"></canvas>
        </div>

      </div>

    </div>

  </main>




<script>
const api = (path) => `http://localhost:8000${path}`;

// TAB SWITCHING
document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-btn").forEach(b => {
      b.classList.remove("bg-indigo-600","text-white");
      b.classList.add("bg-slate-200");
    });
    btn.classList.add("bg-indigo-600","text-white");
    btn.classList.remove("bg-slate-200");

    const tab = btn.getAttribute("data-tab");
    document.querySelectorAll(".tab-content").forEach(ct => ct.classList.add("hidden"));
    document.getElementById("tab-" + tab).classList.remove("hidden");

    loadData();
  };
});

// LOAD DATA
async function loadData() {
  loadBooks();
  loadIssued();
  loadReturnRequests();
  loadReservations();
  loadFines();
}

// LOAD BOOKS
async function loadBooks() {
  const res = await fetch(api("/admin/books"));
  const data = await res.json();

  let html = `<table class="w-full text-left">
    <tr class="border-b font-semibold">
      <td>ID</td><td>Title</td><td>Category</td>
      <td>Rack</td><td>Available</td><td>Actions</td>
    </tr>`;

  data.forEach(b => {
    html += `
      <tr class="border-b">
        <td>${b.id}</td>
        <td>${b.title}</td>
        <td>${b.category}</td>
        <td>${b.rack}</td>
        <td>${b.available_copies}/${b.total_copies}</td>
        <td>
          <button onclick="deleteBook(${b.id})" class="text-red-600">Delete</button>
        </td>
      </tr>`;
  });

  html += "</table>";

  document.getElementById("booksList").innerHTML = html;
}

// ADD BOOK
async function addBook() {
  const payload = {
    title: b_title.value,
    author: b_author.value,
    category: b_category.value,
    rack: b_rack.value,
    total_copies: parseInt(b_total.value)
  };

  await fetch(api("/admin/add_book"), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  alert("Book added!");
  loadBooks();
}

// DELETE BOOK
async function deleteBook(id) {
  if (!confirm("Delete this book?")) return;

  await fetch(api(`/admin/delete_book/${id}`), { method: "DELETE" });

  alert("Book deleted");
  loadBooks();
}

// ISSUED
async function loadIssued() {
  const res = await fetch(api("/admin/issues"));
  const data = await res.json();

  let html = `
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded-xl shadow-lg">
        <thead class="bg-indigo-600 text-white">
          <tr>
            <th class="px-6 py-3 text-left text-sm font-semibold">Book</th>
            <th class="px-6 py-3 text-left text-sm font-semibold">Issued To</th>
            <th class="px-6 py-3 text-left text-sm font-semibold">Due Date</th>
            <th class="px-6 py-3 text-left text-sm font-semibold">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-indigo-100">
  `;

  data.forEach(i => {
    html += `
      <tr class="hover:bg-indigo-50 transition">
        <td class="px-6 py-3 font-medium text-gray-800">${i.title}</td>
        <td class="px-6 py-3 text-gray-700">${i.user}</td>
        <td class="px-6 py-3 text-gray-700">${i.due}</td>
        <td class="px-6 py-3">
          <span class="px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-700 font-semibold">
            Issued
          </span>
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>
  `;

  document.getElementById("issuedList").innerHTML = html;
}


// RETURN REQUESTS
async function loadReturnRequests() {
  const res = await fetch(api("/admin/return_requests"));
  const data = await res.json();

  let html = `<h3 class='font-semibold mb-2'>Pending Return Requests</h3>`;
  if (!data || data.length === 0) {
    html += "<p>No pending requests</p>";
  } else {
    data.forEach(r => {
      html += `
      <div class="border-b py-2">
        <strong>${r.title}</strong> returned by ${r.user}
        <br>
        Returned At: ${r.returned_at} | Due: ${r.due_at}
        
        <div class="mt-2 flex gap-2">
          <button onclick="approveReturn(${r.issue_id})"
            class="bg-green-600 text-white px-2 py-1 rounded text-sm">Approve</button>

          <button onclick="rejectReturn(${r.issue_id})"
            class="bg-red-600 text-white px-2 py-1 rounded text-sm">Reject</button>
        </div>
      </div>`;
    });
  }

  document.getElementById("returnReqList").innerHTML = html;
}

async function approveReturn(issueId) {
  if (!confirm("Approve return?")) return;
  await fetch(api(`/admin/approve_return/${issueId}`), { method: "POST" });
  alert("Return approved.");
  loadReturnRequests();
  loadIssued();
  loadBooks();
}

async function rejectReturn(issueId) {
  if (!confirm("Reject return? This will mark the book as still issued.")) return;
  await fetch(api(`/admin/reject_return/${issueId}`), { method: "POST" });
  alert("Return rejected.");
  loadReturnRequests();
  loadIssued();
}

// RESERVATIONS
async function loadReservations() {
  const res = await fetch(api("/admin/reservations"));
  const data = await res.json();

  let html = `<h3 class="font-semibold mb-2">Reservations</h3>`;
  data.forEach(r => {
    html += `
      <div class="border-b py-2">
        <strong>${r.title}</strong> reserved by ${r.user}
        <span class='text-sm text-slate-500'>(${r.date})</span>
      </div>`;
  });

  document.getElementById("reserveList").innerHTML = html;
}

// FINES
async function loadFines() {
  const res = await fetch(api("/admin/fines"));
  const data = await res.json();

  let html = `<h3 class="font-semibold mb-2">Pending Fines</h3>`;
  data.forEach(f => {
    html += `
      <div class="border-b py-2">
        ${f.user} â†’ <strong>${f.title}</strong>
        <br>Fine: â‚¹${f.amount}
        <button onclick="markFinePaid(${f.id})" class="ml-2 bg-green-600 text-white px-2 py-1 rounded text-sm">
          Mark Paid
        </button>
      </div>`;
  });

  document.getElementById("finesList").innerHTML = html;
}

// MARK FINE PAID
async function markFinePaid(id) {
  await fetch(api(`/admin/pay_fine/${id}`), { method: "POST" });
  alert("Fine marked as paid");
  loadFines();
}


if (localStorage.getItem("isAdmin") !== "true") {
    window.location.href = "/static/admin_login.html";
}


async function loadDashboard() {
  const res = await fetch("/admin/stats");
  const data = await res.json();

  renderCategoryChart(data.categories);
  renderIssuedChart(data.issued, data.reservations);
  renderTopBooks(data.top_books);
}

function renderCategoryChart(items) {
  new Chart(document.getElementById("chartCategories"), {
    type: "pie",
    data: {
      labels: items.map(i => i.category),
      datasets: [{ data: items.map(i => i.count) }]
    }
  });
}

function renderIssuedChart(issued, reservations) {
  new Chart(document.getElementById("chartIssued"), {
    type: "bar",
    data: {
      labels: ["Issued Books", "Reservations"],
      datasets: [{ data: [issued, reservations] }]
    }
  });
}

function renderTopBooks(items) {
  new Chart(document.getElementById("chartTopBooks"), {
    type: "bar",
    data: {
      labels: items.map(i => i.title),
      datasets: [{ data: items.map(i => i.count) }]
    }
  });
}

// When dashboard tab clicked
document.querySelector("[data-tab='dashboard']").onclick = () => loadDashboard();

// initialize: show books tab
document.querySelector("[data-tab='books']").click();

</script>




</body>
</html>


