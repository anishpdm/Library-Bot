<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Library Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 min-h-screen flex items-center justify-center p-4">

  <div class="w-full max-w-3xl bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden flex flex-col border border-white/40" style="height: 86vh;">
    
    <!-- HEADER -->
    <header class="p-4 border-b border-white/40 bg-gradient-to-r from-indigo-500 to-purple-600 text-white flex items-center gap-3 shadow-md">
      <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-lg flex items-center justify-center text-white font-bold shadow-md">LB</div>
      <div>
        <h1 class="text-xl font-bold tracking-wide">Library Assistant</h1>
        <p class="text-sm text-white/80">Search • Issue • Renew • Return</p>
      </div>
      <div id="connectionStatus" class="ml-auto text-sm text-green-200 font-medium">Connected</div>
    </header>

    <!-- MAIN -->
    <main class="flex-1 p-4 overflow-hidden flex flex-col">

      <!-- MESSAGES -->
      <div id="messages" class="flex-1 overflow-auto space-y-4 pr-1"></div>

      <!-- TYPING INDICATOR -->
      <div id="typing" class="px-4 pb-2 hidden text-sm text-indigo-600 animate-pulse">
        Library Bot is typing...
      </div>

      <!-- BOTTOM CONTROLS -->
      <div id="controls" class="px-4 pt-3 pb-5 border-t border-slate-200 bg-white/60 backdrop-blur">
        
        <!-- INPUT ROUTE -->
        <div class="flex gap-2 items-center">
          <input id="searchBox" 
                 class="flex-1 p-3 rounded-xl border border-slate-300 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400 bg-white"
                 placeholder="Type a message or search books..."
                 type="text" />

          <button id="btnVoice" 
                  class="p-3 rounded-xl border border-indigo-300 bg-indigo-100 hover:bg-indigo-200 transition-all shadow-sm flex items-center justify-center">
            <svg id="voiceIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-700" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z"/>
            </svg>
          </button>

          <button id="btnSearch" 
                  class="px-5 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl shadow-md hover:shadow-lg hover:from-indigo-600 hover:to-purple-700 transition-all font-semibold">
            Send
          </button>
        </div>

        <!-- Suggestions -->
        <div id="suggestArea" class="flex gap-2 flex-wrap mt-3"></div>

        <!-- Quick Actions -->
        <div class="flex gap-2 items-center mt-3">

          <button data-action='{"name":"list","page":1,"per_page":5,"category":"all"}'
                  class="px-4 py-2 rounded-full bg-indigo-200 text-indigo-700 font-medium hover:bg-indigo-300 transition shadow">
            List books
          </button>

          <button data-action='{"name":"my_books"}'
                  class="px-4 py-2 rounded-full bg-purple-200 text-purple-700 font-medium hover:bg-purple-300 transition shadow">
            My books
          </button>

          <!-- TTS Controls -->
          <div class="ml-auto flex gap-2 items-center">

            <button id="ttsToggle" 
                    class="px-4 py-2 rounded-xl bg-slate-200 border border-slate-300 flex items-center gap-2 hover:bg-slate-300 transition shadow">
              <svg id="ttsIcon" class="h-5 w-5"></svg>
              <span id="ttsStatus">TTS: Off</span>
            </button>

            <!-- Categories -->
            <div class="flex gap-2 text-sm">
              <button data-cat="all" class="px-4 py-2 rounded-xl bg-white border shadow hover:bg-slate-100">All</button>
              <button data-cat="Python" class="px-4 py-2 rounded-xl bg-white border shadow hover:bg-slate-100">Python</button>
              <button data-cat="ML" class="px-4 py-2 rounded-xl bg-white border shadow hover:bg-slate-100">ML</button>
              <button data-cat="AI" class="px-4 py-2 rounded-xl bg-white border shadow hover:bg-slate-100">AI</button>
            </div>

          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Voice Recognition Popup -->
  <div id="voiceIndicator" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50 backdrop-blur-sm">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 text-center shadow-xl border border-slate-200">
      <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-indigo-100 flex items-center justify-center shadow-inner">
        <svg id="pulseIcon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
          <path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93..."/>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-indigo-700 mb-2">Listening...</h3>
      <p class="text-slate-600 mb-4" id="voiceStatus">Speak now</p>
      <div id="voiceTranscript" class="text-sm text-slate-500 italic mb-4 min-h-6"></div>
      <button id="stopListening" class="px-5 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition shadow">
        Stop Listening
      </button>
    </div>
  </div>





<script>
const messagesEl = document.getElementById("messages");
const typingEl = document.getElementById("typing");
const searchBox = document.getElementById("searchBox");
const btnSearch = document.getElementById("btnSearch");
const btnVoice = document.getElementById("btnVoice");
const voiceIcon = document.getElementById("voiceIcon");
const suggestArea = document.getElementById("suggestArea");
const connectionStatus = document.getElementById("connectionStatus");
const ttsToggle = document.getElementById("ttsToggle");
const ttsStatus = document.getElementById("ttsStatus");
const ttsIcon = document.getElementById("ttsIcon");
const voiceIndicator = document.getElementById("voiceIndicator");
const voiceStatus = document.getElementById("voiceStatus");
const voiceTranscript = document.getElementById("voiceTranscript");
const stopListening = document.getElementById("stopListening");
const pulseIcon = document.getElementById("pulseIcon");

// TTS Configuration
let ttsEnabled = localStorage.getItem("library_bot_tts_enabled") === "true";
let speechSynthesis = window.speechSynthesis;
let currentUtterance = null;

// Speech Recognition Configuration
let recognition = null;
let isListening = false;
let finalTranscript = '';
let alreadyEnded = false; // guard to prevent duplicate onend handling

// Initialize TTS state
updateTtsUI();

// Initialize Speech Recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onstart = () => {
    console.log("Voice recognition started");
    alreadyEnded = false;
    isListening = true;
    updateVoiceUI(true);
    voiceStatus.textContent = "Speak now...";
    voiceTranscript.textContent = "";
    voiceIndicator.classList.remove("hidden");
  };

  recognition.onresult = (event) => {
    let interimTranscript = '';
    
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        finalTranscript += event.results[i][0].transcript;
      } else {
        interimTranscript += event.results[i][0].transcript;
      }
    }
    
    // show interim or final as user is speaking
    voiceTranscript.textContent = finalTranscript || interimTranscript;
    
    // Visual feedback for speech input
    if (interimTranscript) {
      pulseIcon.classList.add("animate-pulse");
    } else {
      pulseIcon.classList.remove("animate-pulse");
    }
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error:", event.error);
    // Ensure we mark listening false and hide UI
    isListening = false;
    alreadyEnded = true;
    updateVoiceUI(false);
    voiceIndicator.classList.add("hidden");
    
    if (event.error === 'not-allowed') {
      appendSystem("Microphone access denied. Please allow microphone access to use voice commands.");
    } else if (event.error === 'no-speech') {
      appendSystem("No speech detected. Please try again.");
    } else {
      appendSystem("Voice recognition error: " + event.error);
    }

    // Reset transcript so subsequent attempts are clean
    finalTranscript = '';
    voiceTranscript.textContent = '';
    pulseIcon.classList.remove("animate-pulse");
  };

  recognition.onend = () => {
    console.log("Voice recognition ended");
    // Prevent double handling of onend
    if (alreadyEnded) return;
    alreadyEnded = true;

    // update flags / UI
    isListening = false;
    updateVoiceUI(false);
    voiceIndicator.classList.add("hidden");
    pulseIcon.classList.remove("animate-pulse");

    // Only send message if we have content
    if (finalTranscript && finalTranscript.trim().length > 0) {
      const transcript = finalTranscript.trim();
      // place in search box and send
      searchBox.value = transcript;
      sendMessage(transcript);
    }

    // Reset transcript for next time
    finalTranscript = '';
    voiceTranscript.textContent = '';
  };
} else {
  console.warn("Speech Recognition not supported in this browser");
  btnVoice.disabled = true;
  btnVoice.title = "Speech recognition not supported";
  voiceIcon.classList.add("text-slate-400");
}

// TTS toggle handler
ttsToggle.addEventListener("click", () => {
  ttsEnabled = !ttsEnabled;
  localStorage.setItem("library_bot_tts_enabled", ttsEnabled.toString());
  updateTtsUI();
  
  if (ttsEnabled) {
    // Test TTS with a welcome message
    speakText("Text to speech is now enabled. Welcome to the Library Assistant.");
  } else {
    // Stop any ongoing speech
    if (speechSynthesis.speaking) {
      speechSynthesis.cancel();
    }
  }
});

// Voice input handler
btnVoice.addEventListener("click", () => {
  if (!recognition) {
    appendSystem("Speech recognition is not supported in your browser.");
    return;
  }
  
  if (isListening) {
    stopRecognition();
  } else {
    startRecognition();
  }
});

// Stop listening button
stopListening.addEventListener("click", () => {
  stopRecognition();
});

function startRecognition() {
  if (!recognition) return;

  // Reset state to ensure a clean start
  try { recognition.abort(); } catch (e) {}
  finalTranscript = '';
  voiceTranscript.textContent = '';
  alreadyEnded = false;
  pulseIcon.classList.remove("animate-pulse");

  try {
    recognition.start();
    // some browsers may throw if start is called too quickly; guard with try/catch
  } catch (err) {
    console.warn("Recognition start error (ignored):", err);
  }
}

function stopRecognition() {
  if (!recognition) return;

  // If recognition is active, stop it. If not, still ensure UI is cleaned up.
  try {
    recognition.stop();
  } catch (e) {
    try { recognition.abort(); } catch (ee) {}
  }

  // Ensure UI and flags are reset immediately (some browsers delay onend)
  isListening = false;
  alreadyEnded = true;
  updateVoiceUI(false);
  voiceIndicator.classList.add("hidden");
  pulseIcon.classList.remove("animate-pulse");
  // clear interim transcript so next session starts fresh
  finalTranscript = '';
  voiceTranscript.textContent = '';
}

function updateTtsUI() {
  if (ttsEnabled) {
    ttsStatus.textContent = "TTS: On";
    ttsToggle.classList.remove("bg-slate-100");
    ttsToggle.classList.add("bg-indigo-100", "text-indigo-700");
    ttsIcon.innerHTML = '<path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" />';
  } else {
    ttsStatus.textContent = "TTS: Off";
    ttsToggle.classList.remove("bg-indigo-100", "text-indigo-700");
    ttsToggle.classList.add("bg-slate-100");
    ttsIcon.innerHTML = '<path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" />';
  }
}

function updateVoiceUI(listening) {
  if (listening) {
    btnVoice.classList.remove("border", "hover:bg-slate-50");
    btnVoice.classList.add("bg-red-500", "text-white");
    voiceIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" />';
  } else {
    btnVoice.classList.remove("bg-red-500", "text-white");
    btnVoice.classList.add("border", "hover:bg-slate-50");
    voiceIcon.innerHTML = '<path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />';
  }
}

function speakText(text) {
  if (!ttsEnabled || !speechSynthesis) return;
  
  // Stop any ongoing speech
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
  }
  
  // Create and configure the utterance
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 0.9;
  utterance.pitch = 1;
  utterance.volume = 0.8;
  
  // Get available voices and set a pleasant one if available
  const voices = speechSynthesis.getVoices();
  const preferredVoice = voices.find(voice => 
    voice.name.includes("Google") || 
    voice.name.includes("Samantha") || 
    voice.name.includes("Karen") ||
    voice.lang.startsWith("en")
  );
  
  if (preferredVoice) {
    utterance.voice = preferredVoice;
  }
  
  currentUtterance = utterance;
  speechSynthesis.speak(utterance);
}

// Handle voice loading
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = () => {
    // Voices are loaded, we can use them now
    console.log("Voices loaded:", speechSynthesis.getVoices().length);
  };
}

let clientId = localStorage.getItem("library_bot_client_id");
if (!clientId) {
  clientId = "user_" + Math.random().toString(36).slice(2, 9);
  localStorage.setItem("library_bot_client_id", clientId);
}

let ws;
let retryMs = 500;
let isIntentionalClose = false;
let reconnectTimeout = null;

function updateConnectionStatus(status, color = 'slate') {
  connectionStatus.textContent = status;
  connectionStatus.className = `ml-auto text-sm text-${color}-500`;
}

function connectWs() {
  // Clear any pending reconnection
  if (reconnectTimeout) {
    clearTimeout(reconnectTimeout);
    reconnectTimeout = null;
  }

  const protocol = location.protocol === "https:" ? "wss" : "ws";
  const url = `${protocol}://${location.host}/ws/${clientId}`;
  console.log("[WS] Connecting:", url);

  updateConnectionStatus('Connecting...', 'yellow');

  ws = new WebSocket(url);

  ws.onopen = () => {
    console.log("[WS] Connected");
    updateConnectionStatus('Connected', 'green');
    appendSystem("Connected to Library Assistant.");
    retryMs = 500;
    isIntentionalClose = false;
  };

  ws.onclose = (event) => {
    console.log("[WS] Disconnected:", event.code, event.reason);
    updateConnectionStatus('Disconnected', 'red');
    
    if (!isIntentionalClose) {
      appendSystem("Disconnected. Reconnecting...");
      reconnectTimeout = setTimeout(() => {
        connectWs();
      }, retryMs);
      retryMs = Math.min(retryMs * 2, 8000);
    }
  };

  ws.onerror = (err) => {
    console.error("[WS] Error:", err);
    updateConnectionStatus('Connection Error', 'red');
  };

  ws.onmessage = (ev) => {
    try {
      const data = JSON.parse(ev.data);
      console.log("[WS] Message:", data);
      handleServerMessage(data);
    } catch (err) {
      console.error("[WS] Parse error:", err);
      appendSystem("Error parsing server message.");
    }
  };
}

// Add cleanup on page unload
window.addEventListener('beforeunload', () => {
  isIntentionalClose = true;
  if (ws) {
    ws.close(1000, "Page navigation");
  }
  if (reconnectTimeout) {
    clearTimeout(reconnectTimeout);
  }
  // Stop any ongoing speech
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
  }
  // Stop voice recognition if active
  if (isListening) {
    stopRecognition();
  }
});

function manualReconnect() {
  if (ws && ws.readyState === WebSocket.OPEN) {
    return;
  }
  isIntentionalClose = false;
  connectWs();
}

function appendSystem(msg) {
  const div = document.createElement("div");
  div.className = "text-center text-sm text-slate-400 italic";
  div.innerText = msg;
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function appendMessage(who, html, textContent = null) {
  const row = document.createElement("div");
  row.className = who === "user" ? "flex justify-end" : "flex justify-start";

  const bubble = document.createElement("div");
  bubble.className = "max-w-[70%] p-3 rounded-2xl";
  bubble.innerHTML = html;

  if (who === "user") {
    bubble.classList.add("bg-indigo-600", "text-white", "rounded-br-none");
  } else {
    bubble.classList.add("bg-slate-100", "text-slate-900", "rounded-bl-none");
    
    // Add TTS play button for bot messages
    if (ttsEnabled && textContent) {
      const playBtn = document.createElement("button");
      playBtn.className = "ml-2 p-1 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 transition-colors";
      playBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
        </svg>
      `;
      playBtn.title = "Play message";
      playBtn.onclick = (e) => {
        e.stopPropagation();
        speakText(textContent);
      };
      
      // Create a container for the message and button
      const container = document.createElement("div");
      container.className = "flex items-center justify-between";
      
      // Move the message content into the container
      const messageContent = bubble.cloneNode(true);
      messageContent.classList.remove("max-w-[70%]");
      messageContent.classList.add("flex-1");
      
      container.appendChild(messageContent);
      container.appendChild(playBtn);
      
      // Replace bubble content with container
      bubble.innerHTML = "";
      bubble.appendChild(container);
      bubble.classList.remove("max-w-[70%]");
    }
  }

  row.appendChild(bubble);
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  // Speak bot messages if TTS is enabled
  if (who === "bot" && ttsEnabled && textContent) {
    speakText(textContent);
  }
}

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, m => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#039;",
  }[m]));
}

function sendMessage(text) {
  if (!text.trim()) return;

  appendMessage("user", escapeHtml(text));

  if (ws && ws.readyState === WebSocket.OPEN) {
    try {
      ws.send(JSON.stringify({ message: text }));
    } catch (err) {
      console.error("Error sending message:", err);
      appendSystem("Failed to send message. Reconnecting...");
      manualReconnect();
    }
  } else {
    appendSystem("Cannot send — WebSocket not connected. Reconnecting...");
    manualReconnect();
  }
}

searchBox.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    const text = searchBox.value.trim();
    if (text.length > 0) {
      sendMessage(text);
      searchBox.value = "";
      suggestArea.innerHTML = "";
    }
  }
});

btnSearch.onclick = () => {
  const text = searchBox.value.trim();
  if (text) {
    sendMessage(text);
    searchBox.value = "";
    suggestArea.innerHTML = "";
  }
};

function attachInlineButtons() {
  document.querySelectorAll("[data-action]").forEach((btn) => {
    if (btn.__wired) return;
    btn.__wired = true;

    btn.onclick = () => {
      try {
        const payload = JSON.parse(btn.getAttribute("data-action"));
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ action: payload }));
        } else {
          appendSystem("Connection lost. Reconnecting...");
          manualReconnect();
        }
      } catch (err) {
        console.error("Invalid data-action", err);
        appendSystem("Error processing action.");
      }
    };
  });
}

document.querySelectorAll("[data-cat]").forEach((btn) => {
  btn.onclick = () => {
    const cat = btn.getAttribute("data-cat");
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ action: { name: "list", page: 1, per_page: 5, category: cat } }));
    } else {
      appendSystem("Connection lost. Reconnecting...");
      manualReconnect();
    }
  };
});

function handleServerMessage(data) {
  switch (data.type) {
    case "bot_message":
      appendMessage("bot", escapeHtml(data.message), data.message);
      break;

    case "typing":
      typingEl.classList.toggle("hidden", !data.value);
      break;

    case "prefill":
      searchBox.value = data.value;
      searchBox.focus();
      break;

    case "suggestions":
      renderSuggestionButtons(data.options);
      break;

    case "search_results":
      renderSearchResults(data.results);
      break;

    case "book_list":
      renderBookList(data.data);
      break;

    case "my_books":
      renderMyBooks(data.items);
      break;
  }
}

function renderSuggestionButtons(options) {
  suggestArea.innerHTML = "";
  for (const o of options) {
    const btn = document.createElement("button");
    btn.className = "px-3 py-2 rounded-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200 transition-colors";
    btn.innerText = o.label;
    btn.onclick = () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ action: o.action }));
      } else {
        appendSystem("Connection lost. Reconnecting...");
        manualReconnect();
      }
    };
    suggestArea.appendChild(btn);
  }
}

function renderSearchResults(items) {
  if (!items.length) {
    appendMessage("bot", "No results found.", "No results found.");
    return;
  }

  let html = "<strong>Search Results:</strong><br/>";
  let textContent = "Search Results: ";

  items.forEach((b, index) => {
    html += `
      <div class="my-2 p-3 border rounded-lg bg-slate-50 shadow-sm">
        <strong>${b.id}. ${escapeHtml(b.title)}</strong><br/>
        Category: ${b.category}<br/>
        <span class="text-indigo-700 font-semibold">Rack: ${b.rack}</span><br/>
        Status: ${b.available ? "✅ Available" : "❌ Not Available"}
        ${b.available 
          ? `<button class="ml-2 px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 transition-colors"
                      data-action='${JSON.stringify({name:"issue_by_id",book_id:b.id})}'>Issue</button>` 
          : ""}
      </div>
    `;

    textContent += `${index + 1}. ${b.title}, category ${b.category}, rack ${b.rack}, ${b.available ? "available" : "not available"}. `;
  });

  appendMessage("bot", html, textContent);
  setTimeout(() => attachInlineButtons(), 50);
}


function renderBookList(data) {
  let html = `<strong>Books (page ${data.page}/${data.total_pages}):</strong><br/>`;
  let textContent = `Books, page ${data.page} of ${data.total_pages}: `;

  data.items.forEach((b, index) => {
    html += `
    ${b.id}. ${escapeHtml(b.title)} — ${b.category} — ${b.available ? "✅ Available" : "❌ Not Available"}
    ${b.available ? `<button class="ml-2 px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 transition-colors" data-action='${JSON.stringify({name:"issue_by_id",book_id:b.id})}'>Issue</button>` : ''}
    <br/>`;
    
    textContent += `${index + 1}. ${b.title}, ${b.category}, ${b.available ? "Available" : "Not Available"}. `;
  });

  const nav = `
    <div class="mt-2 flex gap-2">
      ${data.page > 1 
          ? `<button data-action='${JSON.stringify({name:"list",page:data.page-1,per_page:data.per_page,category:"all"})}'
                     class="px-3 py-1 bg-slate-200 text-sm rounded hover:bg-slate-300 transition-colors">← Previous</button>` 
          : ""}
      ${data.page < data.total_pages 
          ? `<button data-action='${JSON.stringify({name:"list",page:data.page+1,per_page:data.per_page,category:"all"})}'
                     class="px-3 py-1 bg-slate-200 text-sm rounded hover:bg-slate-300 transition-colors">Next →</button>` 
          : ""}
    </div>`;

  appendMessage("bot", html + nav, textContent);
  setTimeout(() => attachInlineButtons(), 50);
}

function renderMyBooks(items) {
  if (!items || items.length === 0) {
    appendMessage("bot", "You have no borrowed books.", "You have no borrowed books.");
    return;
  }

  let html = "<strong>Your Borrowed Books:</strong><br/>";
  let textContent = "Your Borrowed Books: ";

  items.forEach((b, index) => {
    const dueDate = new Date(b.due_at);
    const today = new Date();
    const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
    const dueClass = daysUntilDue <= 3 ? "text-red-500 font-semibold" : "text-green-500";
    
    html += `
      <div class="mb-2 p-2 border rounded">
        <strong>${b.book_id}. ${escapeHtml(b.title)}</strong><br/>
        Issued: ${b.issued_at} — 
        <span class="${dueClass}">Due: ${b.due_at} (${daysUntilDue} days left)</span><br/>
        <div class="mt-1 flex gap-2">
          <button class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors" data-action='${JSON.stringify({name:"renew_by_id",book_id:b.book_id})}'>Renew</button>
          <button class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600 transition-colors" data-action='${JSON.stringify({name:"return_by_id",book_id:b.book_id})}'>Return</button>
        </div>
      </div>`;
    
    textContent += `${index + 1}. ${b.title}, due in ${daysUntilDue} days. `;
  });

  appendMessage("bot", html, textContent);
  setTimeout(() => attachInlineButtons(), 50);
}

connectWs();

const observer = new MutationObserver(() => {
  messagesEl.scrollTop = messagesEl.scrollHeight;
});

observer.observe(messagesEl, {
  childList: true,
  subtree: true
});

window.addEventListener('load', () => {
  searchBox.focus();
  
  // Welcome message with voice instructions
  setTimeout(() => {
    appendSystem("Welcome to Library Assistant! Click the microphone button to use voice commands.");
  }, 500);
});
</script>

</body>
</html>
